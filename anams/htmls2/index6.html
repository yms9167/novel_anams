<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>업무 우선순위 & DAG 관리기</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vis.js CDN for Network Graph Visualization (DAG 시각화 라이브러리) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    
    <style>
        /* Custom styles for better aesthetics and readability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .priority-score {
            font-weight: 700;
            font-size: 1.5rem;
        }
        .task-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-left: 8px solid;
        }
        /* Tailwind classes for priority colors (Red/Yellow/Green) */
        .border-high { border-color: #ef4444; } /* Red-500 */
        .border-medium { border-color: #f59e0b; } /* Amber-500 */
        .border-low { border-color: #10b981; } /* Emerald-500 */
        .border-completed { border-color: #9ca3af; } /* Gray-400 */

        .bg-gradient-high { background-image: linear-gradient(to right, #fef2f2, #fee2e2); }
        .bg-gradient-medium { background-image: linear-gradient(to right, #fffdf2, #fff7d0); }
        .bg-gradient-low { background-image: linear-gradient(to right, #ecfdf5, #d1fae5); }
        .bg-gradient-completed { background-image: linear-gradient(to right, #f3f4f6, #e5e7eb); }

        /* Vis.js network container style */
        #dag-network {
            height: 400px;
            width: 100%;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl equivalent */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 leading-tight">⛓️ DAG 업무 우선순위 관리기</h1>
            <p class="text-gray-600 mt-2">업무 간의 **선형 비순환 종속성(DAG)**을 관리하며, ICE/RICE 모델을 통해 우선순위를 정렬합니다.</p>
        </header>
        
        <!-- 0. 가중치 설정 폼 -->
        <section class="mb-10 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">⚙️ 우선순위 가중치 설정</h2>
            <div id="weight-config" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- 중요도 가중치 -->
                <div>
                    <label for="weight-importance" class="block text-sm font-medium text-gray-700">중요도(I) 가중치</label>
                    <input type="number" id="weight-importance" min="0" value="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-center focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <!-- 긴급도 가중치 -->
                <div>
                    <label for="weight-urgency" class="block text-sm font-medium text-gray-700">긴급도(C) 가중치</label>
                    <input type="number" id="weight-urgency" min="0" value="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-center focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <!-- 영향력 가중치 -->
                <div>
                    <label for="weight-impact" class="block text-sm font-medium text-gray-700">영향력(E) 가중치</label>
                    <input type="number" id="weight-impact" min="0" value="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-center focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <!-- 노력 가중치 -->
                <div>
                    <label for="weight-effort" class="block text-sm font-medium text-gray-700">노력(R) 가중치 (감점)</label>
                    <input type="number" id="weight-effort" min="0" value="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-center focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>
            <p id="formula-display" class="text-xs text-gray-500 mt-3 font-semibold" aria-live="polite">
                *우선순위 점수 = (중요도 x3) + (긴급도 x3) + (영향력 x2) - (노력 x1)
            </p>
        </section>

        <!-- 1. 업무 입력 폼 (이전 2번 섹션) -->
        <section class="mb-10 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">✍️ 새로운 업무 추가</h2>
            <form id="task-form" class="space-y-4">
                <!-- 업무 이름 -->
                <div>
                    <label for="task-name" class="block text-sm font-medium text-gray-700">업무 내용</label>
                    <input type="text" id="task-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" placeholder="예: 2024년 4분기 보고서 작성">
                </div>

                <!-- 종속성 추가 (DAG 핵심) -->
                <div>
                    <label for="dependencies" class="block text-sm font-medium text-gray-700">선행 업무 (종속성)</label>
                    <p class="text-xs text-gray-500 mt-0.5">이 업무를 시작하기 위해 **먼저 완료되어야 하는** 다른 업무들을 선택하세요.</p>
                    <select id="dependencies" multiple class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border h-24">
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>
                
                <!-- 평가 슬라이더 -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- 중요도 -->
                    <div>
                        <label for="importance" class="block text-sm font-medium text-gray-700">중요도 (I) [1-10]</label>
                        <input type="range" id="importance" min="1" max="10" value="5" class="mt-1 w-full" oninput="updateSliderDisplay('importance', this.value)">
                        <output id="importance-value" class="block text-center font-bold text-indigo-600">5</output>
                        <p id="importance-description" class="text-xs text-gray-500 text-center mt-1 h-12 flex items-center justify-center"></p>
                    </div>
                    <!-- 긴급도 -->
                    <div>
                        <label for="urgency" class="block text-sm font-medium text-gray-700">긴급도 (C) [1-10]</label>
                        <input type="range" id="urgency" min="1" max="10" value="5" class="mt-1 w-full" oninput="updateSliderDisplay('urgency', this.value)">
                        <output id="urgency-value" class="block text-center font-bold text-indigo-600">5</output>
                        <p id="urgency-description" class="text-xs text-gray-500 text-center mt-1 h-12 flex items-center justify-center"></p>
                    </div>
                    <!-- 영향력 -->
                    <div>
                        <label for="impact" class="block text-sm font-medium text-gray-700">영향력 (E) [1-10]</label>
                        <input type="range" id="impact" min="1" max="10" value="5" class="mt-1 w-full" oninput="updateSliderDisplay('impact', this.value)">
                        <output id="impact-value" class="block text-center font-bold text-indigo-600">5</output>
                        <p id="impact-description" class="text-xs text-gray-500 text-center mt-1 h-12 flex items-center justify-center"></p>
                    </div>
                    <!-- 노력 -->
                    <div>
                        <label for="effort" class="block text-sm font-medium text-gray-700">노력 (R) [1-10]</label>
                        <input type="range" id="effort" min="1" max="10" value="5" class="mt-1 w-full" oninput="updateSliderDisplay('effort', this.value)">
                        <output id="effort-value" class="block text-center font-bold text-indigo-600">5</output>
                        <p id="effort-description" class="text-xs text-gray-500 text-center mt-1 h-12 flex items-center justify-center"></p>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg">
                    ✅ 업무 추가 및 종속성 확인
                </button>
            </form>
        </section>

        <!-- 2. 우선순위 목록 (이전 3번 섹션) -->
        <section class="mb-10">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">📋 현재 업무 목록 (DAG & 우선순위 순서)</h2>
            <div id="task-list-container" class="space-y-4">
                <!-- Tasks will be rendered here dynamically -->
                <p id="loading-message" class="text-gray-500 text-center p-8">로딩 중...</p>
            </div>
        </section>
        
        <!-- 3. DAG 시각화 영역 -->
        <section class="mt-10 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">🔗 업무 종속성 DAG 시각화</h2>
            <div id="dag-network">
                <!-- Graph will be drawn here -->
            </div>
            <p class="text-xs text-gray-500 mt-2">DAG (Directed Acyclic Graph): 위에서 아래로 업무 흐름을 나타냅니다. 노드를 클릭하면 상세 정보를 확인할 수 있습니다. 그래프가 겹치면 드래그하여 이동할 수 있습니다.</p>
        </section>
        
        <!-- 커스텀 모달 (Confirm 대신 사용) -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <p id="confirm-text" class="text-lg font-semibold mb-6 text-gray-800">정말 삭제하시겠습니까?</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition">취소</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition">삭제</button>
                </div>
            </div>
        </div>
        
        <!-- 에러/정보 모달 (Alert 대신 사용) -->
        <div id="info-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 id="info-title" class="text-xl font-bold mb-3 text-gray-800">알림</h3>
                <p id="info-message" class="text-md text-gray-700 mb-6">메시지 내용</p>
                <div class="flex justify-end">
                    <button id="info-ok-btn" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition">확인</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 상수 및 전역 변수
        const LOCAL_STORAGE_KEY = 'priority_tasks_dag';
        const WEIGHTS_STORAGE_KEY = 'priority_weights';
        const taskForm = document.getElementById('task-form');
        const taskListContainer = document.getElementById('task-list-container');
        const loadingMessage = document.getElementById('loading-message');
        const confirmModal = document.getElementById('confirm-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const infoModal = document.getElementById('info-modal');
        const infoOkBtn = document.getElementById('info-ok-btn');
        const dependenciesSelect = document.getElementById('dependencies');

        let currentTasks = [];
        let taskToDeleteId = null;
        
        // 초기 가중치 설정 (사용자 정의 가능)
        let currentWeights = { importance: 3, urgency: 3, impact: 2, effort: 1 };


        // --- 유틸리티 함수 ---
        
        function showInfoModal(title, message) {
            document.getElementById('info-title').textContent = title;
            document.getElementById('info-message').innerHTML = message; // Use innerHTML for formatted text
            infoModal.classList.remove('hidden');
        }

        infoOkBtn.addEventListener('click', () => {
            infoModal.classList.add('hidden');
        });
        
        /**
         * 1-10 점수에 따른 상세 설명을 반환합니다. (이전과 동일)
         * @param {string} type - 평가 기준 ('importance', 'urgency', 'impact', 'effort')
         * @param {number} score - 점수 (1-10)
         * @returns {string} 상세 설명 텍스트
         */
        function getScoreDescription(type, score) {
            score = parseInt(score);
            let description = '';

            switch(type) {
                case 'importance':
                    // 중요도: 핵심 목표 달성에 얼마나 기여하는가?
                    switch(score) {
                        case 1: description = '매우 낮음: 단순 아이디어/취미성 업무. 미션/KPI와 완전히 무관하며, 생략해도 아무 영향 없음.'; break;
                        case 2: description = '낮음: 목표 달성에 미미한 기여. 가치가 거의 없는 부수적인 작업. (예: 내부 코드 주석 정리)'; break;
                        case 3: description = '약간 낮음: 가치가 낮거나 부수적인 업무. 장기적인 영향이 미약하며, 연관 지표에 1% 미만 영향.'; break;
                        case 4: description = '보통 이하: 표준적인 기대치. 일반적인 가치를 제공함. 이 업무가 없어도 목표 달성은 가능.'; break;
                        case 5: description = '중간: 핵심 목표 달성에 보통 기여함. 완성 시 고객 층의 약 50%가 미세한 만족도 향상을 느낌.'; break;
                        case 6: description = '약간 높음: 주요 목표 달성에 긍정적인 기여. 놓치면 안 될 기회. 연관 지표에 3% 내외 긍정적 영향 예상.'; break;
                        case 7: description = '높음: 성공에 매우 중요한 핵심 요소. 프로젝트의 결과에 상당한 영향을 미침. (예: 주요 기능 개선)'; break;
                        case 8: description = '매우 높음: 전체 프로젝트의 성공에 필수적인 작업. 5% 이상의 지표 개선을 담보함.'; break;
                        case 9: description = '결정적: 비즈니스 연속성 또는 핵심 고객 유치에 결정적. 없으면 서비스 핵심 기능 장애 발생.'; break;
                        case 10: description = '절대적 필수: 비즈니스 존폐/법규 준수에 직결됨. 없으면 서비스가 중단되거나 주요 수익 지표가 30% 이상 즉시 감소함.'; break;
                        default: description = '';
                    }
                    break;
                case 'urgency':
                    // 긴급도: 기한까지 남은 시간, 시간 초과 시 리스크의 크기
                    switch(score) {
                        case 1: description = '매우 여유: 기한 없음. 6개월 이상 여유. 지금 당장 시작할 필요가 전혀 없음.'; break;
                        case 2: description = '여유: 장기 프로젝트 내 여유로운 업무. 기한이 2~3개월 남음. 충분히 계획 가능.'; break;
                        case 3: description = '약간 여유: 기한이 1개월 이상 남음. 미리 시작하면 좋음. 리스크 거의 없음.'; break;
                        case 4: description = '보통 이하: 기한이 2~3주 정도 남음. 루틴한 업무에 해당. 마감일까지 적절한 페이스 유지 필요.'; break;
                        case 5: description = '중간: 기한이 약 1주일 (5~7영업일) 남음. 정규 일정에 맞춰 집중 관리가 필요함.'; break;
                        case 6: description = '약간 촉박: 기한이 4~6일 남음. 일정 관리가 필요함. 지연 시 경고 발생.'; break;
                        case 7: description = '촉박: 기한이 3일 이내로 촉박함. 다른 일정을 조정해야 할 수 있음. 지연 시 고객에게 불편 초래.'; break;
                        case 8: description = '매우 급박: 기한이 1~2일로 매우 급박함. 빠른 대응 필요. 주요 보고서 마감 등.'; break;
                        case 9: description = '심각: 오늘 중 처리하지 않으면 심각한 문제가 발생할 수 있음. (예: 보안 취약점 패치)'; break;
                        case 10: description = 'Critical: 24시간 이내 마감/심각한 시스템 블로커. 지금 즉시 모든 일을 멈추고 투입해야 함.'; break;
                        default: description = '';
                    }
                    break;
                case 'impact':
                    // 영향력: 결과물이 고객, 회사 성과에 얼마나 긍정적인 변화를 주는가?
                    switch(score) {
                        case 1: description = '매우 미미: 영향력 없음. 개인의 편의 향상 (매우 사소한 내부 문서 정리) 수준.'; break;
                        case 2: description = '미미: 소수의 사용자(1% 미만)에게만 작은 개선 또는 불편 해소.'; break;
                        case 3: description = '약간 미미: 사소한 버그 수정 또는 단순 UI 텍스트 개선. 사용자 불만 해소에 소폭 기여.'; break;
                        case 4: description = '보통 이하: 예상되는 고객 만족도 소폭 상승. 측정 가능한 변화는 아님. (예: 툴팁 추가)'; break;
                        case 5: description = '중간: 서비스 핵심 사용자(Active Users)의 50% 이상에게 명확한 개선 체감 또는 월간 지표(MAU)에 3% 미만의 긍정적 변화.'; break;
                        case 6: description = '약간 높음: 주요 지표(예: 이탈률)에 3~5% 측정 가능한 긍정적 변화를 가져옴.'; break;
                        case 7: description = '높음: 주요 KPI를 크게 개선할 잠재력. 명확한 이익 창출. (예: 결제 프로세스 최적화)'; break;
                        case 8: description = '매우 높음: 직접적인 수익/매출 증대에 8% 이상 중대한 영향. 회사의 분기 목표 달성에 기여.'; break;
                        case 9: description = '혁신적: 회사 목표를 극적으로 달성할 수 있는 혁신적 변화. (예: 새로운 수익 모델 도입)'; break;
                        case 10: description = 'Game Changer: 서비스의 핵심 KPI(예: 전환율, 재구매율)를 15% 이상 폭발적으로 개선할 수 있는 잠재력. 신규 시장 개척의 핵심.'; break;
                        default: description = '';
                    }
                    break;
                case 'effort':
                    // 노력: 업무 완료에 필요한 리소스와 시간 (노력은 점수가 높을수록 감점)
                    switch(score) {
                        case 1: description = '매우 쉬움: 1시간 미만 소요. 단순 QA나 텍스트 수정. (노력 점수 감점 최소)'; break;
                        case 2: description = '쉬움: 1일 (1인일) 이내 소요. 단순 반복 작업. 적은 리소스만 필요.'; break;
                        case 3: description = '약간 쉬움: 2일 소요. 큰 리스크 없이 단독으로 완료 가능.'; break;
                        case 4: description = '보통 이하: 2~3일 소요. 중간 정도 복잡도. 가벼운 코드 리뷰 필요.'; break;
                        case 5: description = '중간: 3~5영업일 (약 1인 주) 소요. 평균적인 업무 규모. 중간 규모의 기능 구현.'; break;
                        case 6: description = '약간 어려움: 1주~1.5주 소요. 약간 복잡하거나 여러 팀의 가벼운 협업 필요.'; break;
                        case 7: description = '어려움: 1.5주~2주 소요. 상당한 리소스와 집중적인 노력이 필요. 주요 모듈 리팩토링.'; break;
                        case 8: description = '매우 어려움: 3주 소요. 복잡한 시스템 연동 또는 새로운 기술 도입에 대한 높은 이해 요구.'; break;
                        case 9: description = '대규모: 4주 (1개월) 소요. 대규모 개발/구현이 필요하며 리스크가 높음. 장기 프로젝트의 시작.'; break;
                        case 10: description = '장기 프로젝트: 1개월(4주) 이상 소요. 고도의 리스크 관리 및 다수의 팀 협업이 필요한 대규모 이니셔티브. (노력 점수 최대 감점)'; break;
                        default: description = '';
                    }
                    break;
                default:
                    return '';
            }

            return `[${score}점] ${description}`;
        }


        function updateSliderDisplay(id, value) {
            const valueElement = document.getElementById(`${id}-value`);
            const descElement = document.getElementById(`${id}-description`);
            if (valueElement) {
                valueElement.textContent = value;
            }
            if (descElement) {
                descElement.textContent = getScoreDescription(id, value);
            }
        }

        // --- DAG (Directed Acyclic Graph) 관련 함수 ---

        /**
         * 특정 업무가 시작 가능한지 (모든 선행 업무가 완료되었는지) 확인합니다.
         * @param {Object} task - 업무 객체
         * @returns {boolean} 시작 가능 여부
         */
        function isTaskReady(task) {
            if (task.isCompleted) return false; // 이미 완료되었으면 Ready 상태에서 제외

            if (!task.dependencies || task.dependencies.length === 0) {
                return true; // 종속성이 없으면 바로 시작 가능
            }

            return task.dependencies.every(depId => {
                const depTask = currentTasks.find(t => t.id === depId);
                // 종속된 태스크가 존재하고(오류 방지), 그 태스크가 완료되었는지 확인
                return depTask && depTask.isCompleted;
            });
        }


        // --- 업무 관리 함수 ---

        function loadWeights() {
            try {
                const weightsJson = localStorage.getItem(WEIGHTS_STORAGE_KEY);
                return weightsJson ? JSON.parse(weightsJson) : { importance: 3, urgency: 3, impact: 2, effort: 1 };
            } catch (e) {
                console.error("가중치 로드 실패:", e);
                return { importance: 3, urgency: 3, impact: 2, effort: 1 };
            }
        }

        function saveWeights(weights) {
            try {
                localStorage.setItem(WEIGHTS_STORAGE_KEY, JSON.stringify(weights));
            } catch (e) {
                console.error("가중치 저장 실패:", e);
            }
        }

        function syncWeightInputs() {
            document.getElementById('weight-importance').value = currentWeights.importance;
            document.getElementById('weight-urgency').value = currentWeights.urgency;
            document.getElementById('weight-impact').value = currentWeights.impact;
            document.getElementById('weight-effort').value = currentWeights.effort;
        }

        function setupWeightListeners() {
            const ids = ['importance', 'urgency', 'impact', 'effort'];
            ids.forEach(id => {
                const input = document.getElementById(`weight-${id}`);
                input.addEventListener('input', () => {
                    const newValue = parseInt(input.value) || 0;
                    currentWeights[id] = newValue;
                    saveWeights(currentWeights);
                    updateFormulaDisplay();
                    renderTasks(); 
                });
            });
        }

        function updateFormulaDisplay() {
            const formulaDisplay = document.getElementById('formula-display');
            const i = currentWeights.importance;
            const c = currentWeights.urgency;
            const e = currentWeights.impact;
            const r = currentWeights.effort;
            formulaDisplay.innerHTML = `
                *우선순위 점수 = (중요도 x${i}) + (긴급도 x${c}) + (영향력 x${e}) - (노력 x${r})
            `;
        }

        /**
         * 업무의 우선순위 점수를 계산하고 task 객체에 추가합니다.
         */
        function calculatePriority(task) {
            const weights = currentWeights; 
            const importance = parseInt(task.importance);
            const urgency = parseInt(task.urgency);
            const impact = parseInt(task.impact);
            const effort = parseInt(task.effort);
            
            const score = (importance * weights.importance) + 
                          (urgency * weights.urgency) + 
                          (impact * weights.impact) - 
                          (effort * weights.effort);
            
            task.priorityScore = score;
            task.valueScore = (importance * weights.importance) + (impact * weights.impact);
            task.effortScore = (effort * weights.effort);

            return score;
        }

        function loadTasks() {
            try {
                const tasksJson = localStorage.getItem(LOCAL_STORAGE_KEY);
                return tasksJson ? JSON.parse(tasksJson).map(t => ({
                    ...t,
                    isCompleted: t.isCompleted === true, 
                    dependencies: t.dependencies || []
                })) : [];
            } catch (e) {
                console.error("localStorage 로드 실패:", e);
                return [];
            }
        }

        function saveTasks(tasks) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks));
            } catch (e) {
                console.error("localStorage 저장 실패:", e);
            }
        }

        /**
         * 업무 완료 상태를 토글하고 종속된 업무들의 상태를 재계산합니다.
         */
        function toggleCompletion(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;

            // 완료된 업무를 미완료로 되돌리려는 경우, 
            // 이 태스크를 선행 조건으로 가지는 '미완료된' 자식 태스크가 있는지 확인하여 방지합니다.
            if (task.isCompleted) {
                const hasUncompletedChildren = currentTasks.some(t => 
                    !t.isCompleted && // 미완료된 업무만 확인
                    t.dependencies.includes(taskId)
                );
                
                if (hasUncompletedChildren) {
                    showInfoModal("경고", "이 업무를 미완료 상태로 되돌리려면, 이 업무에 종속된 미완료 업무들을 먼저 완료하거나 종속성을 변경해야 합니다.");
                    return;
                }
            }
            
            task.isCompleted = !task.isCompleted;
            
            saveTasks(currentTasks);
            renderTasks();
        }

        /**
         * 업무 목록을 우선순위, 준비 상태 기준으로 정렬하고 렌더링합니다.
         */
        function renderTasks() {
            // 1. 점수 및 상태 계산
            currentTasks.forEach(task => {
                calculatePriority(task);
                task.isReady = isTaskReady(task); // Ready 상태 업데이트
            });
            
            // 2. 정렬: 미완료 > 시작 가능 > 점수 높은 순
            currentTasks.sort((a, b) => {
                // 1. 완료 상태 (미완료가 먼저, false < true)
                if (a.isCompleted !== b.isCompleted) {
                    return a.isCompleted ? 1 : -1;
                }
                
                // 2. Ready 상태 (Ready가 먼저, true > false)
                if (a.isReady !== b.isReady) {
                    return a.isReady ? -1 : 1;
                }

                // 3. 점수 (점수 높은 순)
                return b.priorityScore - a.priorityScore;
            });

            // 3. 순위 (Rank) 할당
            currentTasks.forEach((task, index) => {
                task.rank = index + 1;
            });
            
            // 4. 종속성 셀렉터 업데이트
            renderDependencySelector();

            // 5. DOM 업데이트 (업무 목록)
            taskListContainer.innerHTML = '';
            loadingMessage.classList.add('hidden');

            if (currentTasks.length === 0) {
                taskListContainer.innerHTML = '<p class="text-gray-500 text-center p-8 bg-white rounded-xl">✨ 아직 업무가 없습니다. 새로운 업무를 추가해보세요!</p>';
            }

            currentTasks.forEach(task => {
                const isCompleted = task.isCompleted;
                const isReady = task.isReady;
                
                // 점수 기반 색상 결정 (1-10 범위, 최대 점수 약 79점 기준)
                const priorityClass = isCompleted ? 'border-completed bg-gradient-completed' :
                                      task.priorityScore >= 55 ? 'border-high bg-gradient-high' : // 55점 이상 (High)
                                      task.priorityScore >= 32 ? 'border-medium bg-gradient-medium' : // 32점 이상 (Medium)
                                      'border-low bg-gradient-low'; // 그 외 (Low)
                
                const taskCard = document.createElement('div');
                taskCard.className = `task-card flex flex-col md:flex-row md:items-center justify-between p-4 rounded-xl ${priorityClass}`;
                taskCard.dataset.id = task.id;

                const depNames = task.dependencies.map(depId => {
                    const depTask = currentTasks.find(t => t.id === depId);
                    return depTask ? depTask.name : '알 수 없는 업무';
                });
                
                let statusBadge;
                if (isCompleted) {
                    statusBadge = '<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-gray-500 text-white">✅ 완료됨</span>';
                } else if (isReady) {
                    statusBadge = '<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-emerald-500 text-white">🟢 시작 가능</span>';
                } else {
                    statusBadge = '<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-500 text-white">🟡 대기 중</span>';
                }

                taskCard.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-2 md:mb-0">
                            <span class="text-xl font-bold text-gray-800">#${task.rank}</span>
                            <p class="text-lg font-semibold text-gray-900 truncate ${isCompleted ? 'line-through text-gray-500' : ''}">${task.name}</p>
                            ${statusBadge}
                        </div>
                        <div class="mt-1 text-sm text-gray-700 flex flex-wrap gap-x-4 gap-y-1">
                            <span title="Importance">I: ${task.importance}</span>
                            <span title="Urgency">C: ${task.urgency}</span>
                            <span title="Impact">E: ${task.impact}</span>
                            <span title="Effort">R: ${task.effort}</span>
                        </div>
                        ${depNames.length > 0 ? `
                            <p class="text-xs text-gray-600 mt-2 italic">
                                선행 업무: ${depNames.join(', ')}
                            </p>
                        ` : ''}
                    </div>
                    <div class="flex items-center space-x-3 mt-3 md:mt-0 ml-4">
                        <span class="priority-score text-gray-800">${task.priorityScore.toFixed(1)}</span>
                        <button class="toggle-btn px-3 py-1 text-sm font-medium rounded-lg transition duration-150 ${isCompleted ? 'bg-gray-400 hover:bg-gray-500 text-white' : 'bg-green-600 hover:bg-green-700 text-white'}">
                            ${isCompleted ? '미완료로' : '완료하기'}
                        </button>
                        <button class="delete-btn text-gray-500 hover:text-red-600 transition p-2 rounded-full hover:bg-gray-100" aria-label="업무 삭제">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                taskListContainer.appendChild(taskCard);
            });

            // 6. DAG 시각화
            drawNetwork(currentTasks);

            // 7. 이벤트 리스너 추가 (목록 항목)
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const taskId = e.currentTarget.closest('.task-card').dataset.id;
                    showDeleteConfirmModal(taskId);
                });
            });
            document.querySelectorAll('.toggle-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const taskId = e.currentTarget.closest('.task-card').dataset.id;
                    toggleCompletion(taskId);
                });
            });
        }
        
        /**
         * Vis.js를 사용하여 DAG 네트워크를 그립니다.
         * @param {Array<Object>} tasks - 현재 업무 목록
         */
        function drawNetwork(tasks) {
            const container = document.getElementById('dag-network');
            
            // Clear previous network
            if (container) {
                container.innerHTML = '';
            }

            if (tasks.length === 0 || !container) {
                return;
            }

            const nodes = [];
            const edges = [];

            // 1. 노드(Nodes) 및 엣지(Edges) 데이터 준비
            tasks.forEach(task => {
                let color, statusLabel;
                
                // 노드 색상 및 상태 결정
                if (task.isCompleted) {
                    color = { background: '#9ca3af', border: '#6b7280' }; // Gray (Completed)
                    statusLabel = '✅ 완료';
                } else if (task.isReady) {
                    color = { background: '#10b981', border: '#059669' }; // Green (Ready)
                    statusLabel = '🟢 시작 가능';
                } else {
                    color = { background: '#f59e0b', border: '#d97706' }; // Amber (Waiting)
                    statusLabel = '🟡 대기 중';
                }

                const scoreText = `점수: ${task.priorityScore.toFixed(1)}`;
                const details = `\nI:${task.importance} C:${task.urgency} E:${task.impact} R:${task.effort}`;
                
                nodes.push({
                    id: task.id,
                    // HTML을 사용하면 개행 문자를 인식하여 두 줄로 표시 가능
                    label: `${task.name}\n[${statusLabel}]`, 
                    title: `${task.name}\n${scoreText}${details}`, // Tooltip
                    color: color,
                    shape: 'box',
                    font: { color: '#ffffff', multi: 'html', size: 14 },
                    taskData: task, // Store task data for click handling
                });

                // 엣지(Edges - 종속성) 추가
                task.dependencies.forEach(depId => {
                    // 종속성으로 지정된 업무가 존재하는지 확인
                    if (tasks.find(t => t.id === depId)) {
                        edges.push({
                            from: depId,
                            to: task.id,
                            // 화살표를 더 굵고 눈에 띄게 설정 (인디고색 적용)
                            arrows: { to: { enabled: true, scaleFactor: 1.2, type: 'arrow' } }, 
                            color: { color: '#4f46e5', highlight: '#3730a3', hover: '#3730a3' }, // Indigo-600 color
                            width: 3 
                        });
                    }
                });
            });

            const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };

            // 2. 그래프 옵션 설정 (DAG에 적합한 계층적 레이아웃 사용)
            const options = {
                interaction: {
                    zoomView: true,
                    dragNodes: true, // 노드 이동 허용
                    dragView: true
                },
                layout: {
                    hierarchical: {
                        direction: 'UD', // Up-Down 레이아웃 (위에서 아래로 흐름)
                        sortMethod: 'directed', // DAG에 따라 노드 정렬
                        levelSeparation: 120, // 레벨 간격
                        nodeSpacing: 180, // 노드 간격
                    }
                },
                physics: {
                    enabled: false // 안정적인 계층적 레이아웃을 위해 물리 엔진 비활성화
                },
                edges: {
                    smooth: {
                        enabled: true,
                        type: 'cubicBezier',
                        forceDirection: 'vertical',
                        roundness: 0.4
                    }
                }
            };

            // 3. 네트워크 그리기
            const network = new vis.Network(container, data, options);
            
            // 4. 클릭 이벤트 리스너 추가 (상세 정보 팝업)
            network.on("click", function (params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const clickedNode = nodes.find(n => n.id === nodeId);
                    if (clickedNode && clickedNode.taskData) {
                        const task = clickedNode.taskData;
                        const depNames = task.dependencies.map(depId => {
                            const depTask = tasks.find(t => t.id === depId);
                            return depTask ? depTask.name : '알 수 없는 업무';
                        }).join(', ');
                        
                        showInfoModal(
                            `업무 상세 정보 (#${task.rank})`,
                            `
                            <strong class="text-indigo-600">${task.name}</strong><br>
                            <span class="text-lg font-bold">우선순위 점수: ${task.priorityScore.toFixed(1)}</span><br>
                            <strong>상태:</strong> ${task.isCompleted ? '✅ 완료됨' : task.isReady ? '🟢 시작 가능' : '🟡 대기 중'}<br>
                            <hr class="my-2 border-gray-200">
                            <strong>I (중요도):</strong> ${task.importance}<br>
                            <strong>C (긴급도):</strong> ${task.urgency}<br>
                            <strong>E (영향력):</strong> ${task.impact}<br>
                            <strong>R (노력):</strong> ${task.effort}<br>
                            <hr class="my-2 border-gray-200">
                            <strong>선행 업무:</strong> ${depNames || '없음'}
                            `
                        );
                    }
                }
            });
        }


        // --- 종속성 셀렉터 렌더링 함수 ---
        function renderDependencySelector() {
            dependenciesSelect.innerHTML = '';
            
            // 모든 미완료 업무를 옵션으로 추가
            currentTasks.filter(t => !t.isCompleted).forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = `#${task.rank}: ${task.name} (점수: ${task.priorityScore.toFixed(1)})`;
                dependenciesSelect.appendChild(option);
            });

            // 옵션이 없을 때 (아직 업무가 없을 때)
            if (dependenciesSelect.options.length === 0) {
                 const option = document.createElement('option');
                option.value = '';
                option.textContent = '선행 업무 없음';
                option.disabled = true;
                option.selected = true;
                dependenciesSelect.appendChild(option);
            }
        }


        // --- 기타 함수 (삭제 모달) ---

        function showDeleteConfirmModal(taskId) {
            // 이 업무를 선행 조건으로 가지는 자식 태스크가 있는지 확인
            const hasChildren = currentTasks.some(t => t.dependencies.includes(taskId));

            if (hasChildren) {
                showInfoModal("삭제 불가", "이 업무를 삭제하려면, 먼저 이 업무에 **종속된** 다른 모든 업무의 종속성 목록에서 이 업무를 제거하거나 삭제해야 합니다.");
                return;
            }

            taskToDeleteId = taskId;
            document.getElementById('confirm-text').textContent = '선택하신 업무를 정말 삭제하시겠습니까? (이 업무에 종속된 업무는 없습니다.)';
            confirmModal.classList.remove('hidden');
        }

        function deleteTask() {
            if (!taskToDeleteId) return;

            // 해당 업무를 종속성으로 가지고 있는 다른 업무가 없는지 한 번 더 확인 (이중 체크)
            const hasChildren = currentTasks.some(t => t.dependencies.includes(taskToDeleteId));
            if (hasChildren) {
                 showInfoModal("오류", "삭제에 실패했습니다. 이 업무를 선행 업무로 지정한 다른 업무가 존재합니다.");
                 confirmModal.classList.add('hidden');
                 taskToDeleteId = null;
                 return;
            }

            currentTasks = currentTasks.filter(task => task.id !== taskToDeleteId);
            
            saveTasks(currentTasks);
            renderTasks();

            taskToDeleteId = null;
            confirmModal.classList.add('hidden');
        }

        // --- 이벤트 리스너 설정 ---

        // 1. 업무 추가 폼 제출 처리
        taskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const taskName = document.getElementById('task-name').value.trim();
            if (!taskName) return;

            const importanceValue = document.getElementById('importance').value;
            const urgencyValue = document.getElementById('urgency').value;
            const impactValue = document.getElementById('impact').value;
            const effortValue = document.getElementById('effort').value;
            
            const selectedDependencies = Array.from(dependenciesSelect.selectedOptions).map(option => option.value);

            // 순환 감지 로직은 종속성 변경 시에 주로 필요하며, 
            // 새로운 업무가 항상 DAG의 끝(자식)에 추가되므로 현재는 생략합니다.
            
            const newTask = {
                id: crypto.randomUUID(), 
                name: taskName,
                importance: importanceValue,
                urgency: urgencyValue,
                impact: impactValue,
                effort: effortValue,
                isCompleted: false, 
                dependencies: selectedDependencies, 
            };

            currentTasks.push(newTask);
            
            saveTasks(currentTasks);
            renderTasks();

            // 폼 초기화
            taskForm.reset();
            // 1-10 범위의 기본값은 5로 설정
            document.getElementById('importance').value = 5; 
            document.getElementById('urgency').value = 5;   
            document.getElementById('impact').value = 5;    
            document.getElementById('effort').value = 5;    
            updateSliderDisplay('importance', '5');
            updateSliderDisplay('urgency', '5');
            updateSliderDisplay('impact', '5');
            updateSliderDisplay('effort', '5');
        });

        // 2. 모달 버튼 이벤트
        modalConfirmBtn.addEventListener('click', deleteTask);
        modalCancelBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            taskToDeleteId = null;
        });
        
        // 3. 페이지 로드 시 초기 데이터 로드 및 렌더링
        window.onload = function() {
            // 1. 가중치 로드 및 설정
            currentWeights = loadWeights();
            syncWeightInputs();
            updateFormulaDisplay();
            setupWeightListeners(); 
            
            // 2. 업무 로드 및 렌더링
            currentTasks = loadTasks();
            renderTasks();
            
            // 3. 초기 로드 시 슬라이더 디스플레이 초기화
            // 모든 슬라이더에 대해 초기값과 설명을 설정합니다.
            const sliders = ['importance', 'urgency', 'impact', 'effort'];
            sliders.forEach(id => {
                updateSliderDisplay(id, document.getElementById(id).value);
            });
        };

    </script>
</body>
</html>
