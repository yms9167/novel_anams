import streamlit as st
import streamlit.components.v1 as components
import os
import json
import numpy as np
import time
import requests
from urllib.parse import urlparse, parse_qs

# --- Orange ëª¨ë¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë° ì„œë¹„ìŠ¤ ì„í¬íŠ¸ ì‹œë„ ---
# Orange ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤ (pip install orange3)
try:
    import Orange
    from Orange.data import Table, Domain, ContinuousVariable
    ORANGE_AVAILABLE = True
except ImportError:
    ORANGE_AVAILABLE = False
    # Orange ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìœ¼ë©´ ì˜ˆì¸¡ì€ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.

# --- íŒŒì¼ ë° ê²½ë¡œ ì„¤ì • ---
HTML_FILE_NAME = 'index6.html'
HTML_FOLDER = 'htmls'
HTML_FILE_PATH = os.path.join(HTML_FOLDER, HTML_FILE_NAME)

MODEL_FILES = {
    'RNN': 'ë ¬ë‰´.pkcls',
    'SVM': 'SVM.pkcls',
    'kNN': 'kNNì •ë³´ê³¼ì œ.pkcls'
}

# --- í—¬í¼ í•¨ìˆ˜: HTML ë‚´ìš© ë¡œë“œ ---
def load_html_content(filepath):
    """ì§€ì •ëœ ê²½ë¡œì—ì„œ HTML íŒŒì¼ ë‚´ìš©ì„ ì½ì–´ì˜µë‹ˆë‹¤."""
    if not os.path.exists(filepath):
        return f"<div style='padding: 20px; color: red;'>ì˜¤ë¥˜: HTML íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: <strong>{filepath}</strong></div>"
    
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return f.read()
    except Exception as e:
        return f"<div style='padding: 20px; color: red;'>íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}</div>"

# --- Orange ëª¨ë¸ ë¡œë“œ ë° ì˜ˆì¸¡ ë¡œì§ ---
@st.cache_resource
def load_orange_models():
    """ì•± ì‹œì‘ ì‹œ Orange ëª¨ë¸ íŒŒì¼ë“¤ì„ ë¡œë“œí•©ë‹ˆë‹¤."""
    loaded_models = {}
    if not ORANGE_AVAILABLE:
        return loaded_models, False, "Orange ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."

    success_flag = True
    messages = []
    
    for key, filename in MODEL_FILES.items():
        try:
            # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            if not os.path.exists(filename):
                messages.append(f"âŒ {filename} íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê²½ë¡œ í™•ì¸ í•„ìš”)")
                loaded_models[key] = None
                success_flag = False
                continue

            model = Orange.classification.load(filename)
            loaded_models[key] = model
            messages.append(f"âœ… {key} ëª¨ë¸ ë¡œë“œ ì„±ê³µ.")
        except Exception as e:
            messages.append(f"âŒ {key} ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨. ì˜¤ë¥˜: {e}")
            loaded_models[key] = None
            success_flag = False
            
    if success_flag:
        return loaded_models, True, "ëª¨ë“  Orange ëª¨ë¸ ë¡œë“œ ì™„ë£Œ."
    else:
        return loaded_models, False, "\n".join(messages)

def predict_with_orange_models(data_input, loaded_models):
    """ë¡œë“œëœ Orange ëª¨ë¸ë¡œ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤."""
    
    if not loaded_models or not any(loaded_models.values()):
        return None, "Orange ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ìŒ."

    try:
        # ì…ë ¥ íŠ¹ì§• ì •ì˜ (ìˆœì„œëŠ” ëª¨ë¸ í•™ìŠµ ì‹œ ì‚¬ìš©í•œ ìˆœì„œì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤)
        features = [
            ContinuousVariable('weight'), ContinuousVariable('height'), ContinuousVariable('heartRate'), 
            ContinuousVariable('targetWeight'), ContinuousVariable('targetDuration'), 
            ContinuousVariable('workoutDays'), ContinuousVariable('workoutTime'),
        ]
        test_domain = Domain(features)
        
        # ì…ë ¥ê°’ì„ Orange Table í˜•íƒœë¡œ ë³€í™˜
        data_vector = [
            data_input['weight'], data_input['height'], data_input['heartRate'],
            data_input['targetWeight'], data_input['targetDuration'],
            data_input['workoutDays'], data_input['workoutTime'],
        ]
        data_instance = Table(test_domain, [data_vector])
        
        predictions = {}
        for key, model in loaded_models.items():
            if model:
                # model()ì„ ì‚¬ìš©í•˜ì—¬ ì˜ˆì¸¡ ìˆ˜í–‰
                prediction_index = int(model(data_instance)[0])
                # ì˜ˆì¸¡ëœ í´ë˜ìŠ¤ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                class_name = model.domain.class_var.values[prediction_index]
                predictions[key] = class_name
            # ëª¨ë¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆê±°ë‚˜ (model is None) ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ê²½ìš° í‚¤ë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
        
        if predictions:
            return predictions, "ì‹¤ì œ Orange ëª¨ë¸ ì˜ˆì¸¡ ì„±ê³µ"
        else:
            return None, "ë¡œë“œëœ ëª¨ë¸ì´ ì—†ì–´ ì˜ˆì¸¡ ë¶ˆê°€"

    except Exception as e:
        return None, f"ì˜ˆì¸¡ ë¡œì§ ì˜¤ë¥˜ ë°œìƒ: {e}"


def simulate_orange_prediction(data_input):
    """ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì˜ˆì¸¡ì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤."""
    # ì‹œë®¬ë ˆì´ì…˜ ë¡œì§ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
    target_diff = data_input['weight'] - data_input['targetWeight']
    
    if target_diff < 0 or data_input['targetDuration'] < 7:
        result = "ìš”ê°€/í•„ë¼í…ŒìŠ¤"
    elif data_input['workoutDays'] >= 5 and data_input['workoutTime'] >= 1.5:
        result = "ë³µí•© íŠ¸ë ˆì´ë‹"
    elif data_input['heartRate'] > 80:
        result = "ìˆ˜ì˜"
    else:
        result = "ëŸ°ë‹"

    return {
        'RNN': result, 
        'SVM': result, 
        'kNN': result
    }, "Orange ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨ë¡œ ì‹œë®¬ë ˆì´ì…˜ ì˜ˆì¸¡ ìˆ˜í–‰"

def get_ai_coach_recommendation(data_input, predictions):
    """Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³  ë§ì¶¤í˜• ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    # ëª¨ë¸ë“¤ì˜ ì˜ˆì¸¡ ê²°ê³¼ ì¤‘ ê°€ì¥ ë§ì´ ë‚˜ì˜¨ ì¢…ëª©ì„ ìµœì¢… ì¶”ì²œìœ¼ë¡œ ì„ íƒ
    all_preds = list(predictions.values())
    unique, counts = np.unique(all_preds, return_counts=True)
    final_recommendation = unique[np.argmax(counts)]

    system_prompt = (
        "ë‹¹ì‹ ì€ ì‚¬ìš©ì ë°ì´í„°ì™€ ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì˜ ì˜ˆì¸¡ì„ ê¸°ë°˜ìœ¼ë¡œ ë§ì¶¤í˜• ìš´ë™ ì¢…ëª©ì„ ì¶”ì²œí•˜ëŠ” ì „ë¬¸ AI ê±´ê°• ì½”ì¹˜ì…ë‹ˆë‹¤. "
        "ì¹œì ˆí•˜ê³  ë™ê¸° ë¶€ì—¬ê°€ ë˜ëŠ” í†¤ìœ¼ë¡œ, ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìµœì¢… ì¶”ì²œ ì¢…ëª©ì„ ì œì‹œí•˜ë©°, ëª©í‘œ ë‹¬ì„± ì „ëµì„ ìš”ì•½í•˜ì—¬ í•œêµ­ì–´ë¡œ ë‹µë³€í•˜ì„¸ìš”. "
        "ì‘ë‹µì€ ì œëª© ì—†ì´ ë‹¨ë½ìœ¼ë¡œ êµ¬ì„±í•˜ê³ , ì˜ˆì¸¡ ê²°ê³¼ì™€ ì‚¬ìš©ì ëª©í‘œë¥¼ ëª…í™•í•˜ê²Œ ì–¸ê¸‰í•˜ì„¸ìš”."
    )

    user_query = f"""
    ì‚¬ìš©ì ë°ì´í„°: (ëª¸ë¬´ê²Œ: {data_input['weight']}kg, í‚¤: {data_input['height']}cm, ì‹¬ë°•ìˆ˜: {data_input['heartRate']}bpm, ëª©í‘œ ëª¸ë¬´ê²Œ: {data_input['targetWeight']}kg, ëª©í‘œ ê¸°ê°„: {data_input['targetDuration']}ì¼, ì£¼ë‹¹ ìš´ë™ íšŸìˆ˜: {data_input['workoutDays']}ì¼, ì¼ë‹¹ ìš´ë™ ì‹œê°„: {data_input['workoutTime']}ì‹œê°„)
    ì„¸ ê°€ì§€ ë¨¸ì‹ ëŸ¬ë‹ ëª¨ë¸ì˜ ì˜ˆì¸¡ ê²°ê³¼: {predictions}
    ìµœì¢… ì¶”ì²œ ì¢…ëª©: {final_recommendation}
    ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ë™ê¸° ë¶€ì—¬ê°€ ë˜ëŠ” ì „ë¬¸ì ì¸ ì¶”ì²œ ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.
    """
    
    apiKey = "" 
    apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key="

    payload = { "contents": [{"parts": [{"text": user_query}]}], "systemInstruction": {"parts": [{"text": system_prompt}]} }

    try:
        max_retries = 3
        wait_time = 1
        response = None
        for attempt in range(max_retries):
            response = requests.post(apiUrl, headers={'Content-Type': 'application/json'}, data=json.dumps(payload))
            if response.status_code == 200:
                break
            time.sleep(wait_time)
            wait_time *= 2
        
        response.raise_for_status()
        result = response.json()
        text = result['candidates'][0]['content']['parts'][0]['text']
        return text

    except Exception as e:
        return (
            "ì£„ì†¡í•©ë‹ˆë‹¤. AI ì½”ì¹˜ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì˜¤ë¥˜: " + str(e) + 
            ") í•˜ì§€ë§Œ ëª¨ë¸ë“¤ì€ " + final_recommendation + "ë¥¼ ì¶”ì²œí•˜ê³  ìˆìŠµë‹ˆë‹¤."
        )

# --- Streamlit UI êµ¬í˜„ ---
def app():
    st.set_page_config(layout="wide", page_title="Streamlit í†µí•© ì•±")
    
    st.title("Streamlit + HTML/JS + Orange ì˜ˆì¸¡ í†µí•© ë°ëª¨")
    st.markdown("ì´ ì•±ì€ HTML UIë¥¼ í¬í•¨í•˜ê³ , Streamlitì˜ Python ë¡œì§(Orange ëª¨ë¸)ìœ¼ë¡œ ì˜ˆì¸¡ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.")
    st.divider()

    # --- 0. URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì½ê¸° ë° ê¸°ë³¸ê°’ ì„¤ì • ---
    # st.query_paramsëŠ” V1.35.0ë¶€í„° st.experimental_get_query_params()ë¥¼ ëŒ€ì²´í•©ë‹ˆë‹¤.
    query_params = st.query_params

    # ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ ê°’ì„ ì½ì–´ì˜´ (ê°’ì€ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ì˜¤ë¯€ë¡œ ì²« ë²ˆì§¸ ìš”ì†Œë¥¼ ì‚¬ìš©)
    DEFAULT_INPUTS = {
        'w': 70.0, 'h': 175.0, 'hr': 75, 'tw': 65.0, 'td': 90, 'wd': 3, 'wt': 1.0
    }
    
    # ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°’ì´ ì—†ìœ¼ë©´ DEFAULT_INPUTSì˜ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    weight_init = float(query_params.get('w', [DEFAULT_INPUTS['w']])[0])
    height_init = float(query_params.get('h', [DEFAULT_INPUTS['h']])[0])
    hr_init = int(query_params.get('hr', [DEFAULT_INPUTS['hr']])[0])
    tw_init = float(query_params.get('tw', [DEFAULT_INPUTS['tw']])[0])
    td_init = int(query_params.get('td', [DEFAULT_INPUTS['td']])[0])
    wd_init = int(query_params.get('wd', [DEFAULT_INPUTS['wd']])[0])
    wt_init = float(query_params.get('wt', [DEFAULT_INPUTS['wt']])[0])

    # --- ëª¨ë¸ ë¡œë“œ ---
    loaded_models, model_load_success, load_message = load_orange_models()
    
    # ëª¨ë¸ ë¡œë“œ ìƒíƒœ í‘œì‹œ
    if model_load_success:
        st.success(f"ëª¨ë¸ ë¡œë“œ ìƒíƒœ: {load_message}")
    elif ORANGE_AVAILABLE:
        st.warning(f"ëª¨ë¸ ë¡œë“œ ìƒíƒœ: {load_message}. ì˜ˆì¸¡ì€ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.")
    else:
        st.info(f"ëª¨ë¸ ë¡œë“œ ìƒíƒœ: {load_message}. ì˜ˆì¸¡ì€ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.")

    
    # --- HTML UI í‘œì‹œ ---
    st.header("1. HTML UI í‘œì‹œ")
    st.markdown("HTML UIì˜ **'ìš´ë™ ì¶”ì²œë°›ê¸°'** ë²„íŠ¼ì„ í´ë¦­í•˜ë©´, ì…ë ¥ê°’ì´ ì•„ë˜ **Streamlit ì˜ˆì¸¡ ê¸°ëŠ¥** ìœ„ì ¯ì— ìë™ ë°˜ì˜ë©ë‹ˆë‹¤. (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°œìƒ)")
    
    # HTML íŒŒì¼ ë‚´ìš© ë¡œë“œ ë° ì»´í¬ë„ŒíŠ¸ë¡œ ì‚½ì…
    # URL ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜ë¥¼ í¬í•¨í•˜ì—¬ HTMLì„ ë¡œë“œí•˜ë©´, HTML ë‚´ë¶€ì˜ JSê°€ ì´ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    html_content = load_html_content(HTML_FILE_PATH)
    components.html(html_content, height=800, scrolling=True)

    st.divider()
    
    # --- Streamlitì—ì„œ ì§ì ‘ ë°ì´í„°ë¥¼ ë°›ì•„ ì˜ˆì¸¡ ìˆ˜í–‰ (ì‹¤ì œ ì˜ˆì¸¡ ê²½ë¡œ) ---
    st.header("2. Streamlit ì˜ˆì¸¡ ê¸°ëŠ¥ (Python ë¡œì§ ì‹¤í–‰)")
    
    # ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
    if any(key in query_params for key in DEFAULT_INPUTS.keys()):
        st.info("â¬†ï¸ ìƒë‹¨ HTML UIì—ì„œ ë¡œë“œëœ ê°’ì´ ì•„ë˜ ìœ„ì ¯ì— ìë™ìœ¼ë¡œ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤. ì´ì œ 'Streamlitìœ¼ë¡œ ì˜ˆì¸¡ ì‹¤í–‰'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!")
    else:
        st.warning("ìˆ˜ë™ìœ¼ë¡œ ê°’ì„ ì…ë ¥í•˜ê±°ë‚˜, ìƒë‹¨ HTML UIë¥¼ ì‚¬ìš©í•˜ì—¬ ê°’ì„ ë¡œë“œí•˜ì„¸ìš”.")

    with st.form("prediction_form"):
        
        col1, col2, col3 = st.columns(3)
        # ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ ì½ì–´ì˜¨ ê°’ìœ¼ë¡œ ìœ„ì ¯ì˜ default ê°’ì„ ì„¤ì •
        weight = col1.number_input("í˜„ì¬ ëª¸ë¬´ê²Œ (kg)", min_value=10.0, max_value=300.0, value=weight_init, step=0.1, key="w_input")
        height = col2.number_input("í‚¤ (cm)", min_value=50.0, max_value=250.0, value=height_init, step=0.1, key="h_input")
        heartRate = col3.number_input("í‰ê·  ì‹¬ë°•ìˆ˜ (bpm)", min_value=40, max_value=200, value=hr_init, step=1, key="hr_input")
        
        col4, col5 = st.columns(2)
        targetWeight = col4.number_input("ëª©í‘œ ëª¸ë¬´ê²Œ (kg)", min_value=10.0, max_value=300.0, value=tw_init, step=0.1, key="tw_input")
        targetDuration = col5.number_input("ëª©í‘œ ê¸°ê°„ (ì¼)", min_value=1, max_value=3650, value=td_init, step=1, key="td_input")
        
        col6, col7 = st.columns(2)
        workoutDays = col6.slider("ì£¼ë‹¹ ìš´ë™í•˜ëŠ” ì¼ ìˆ˜ (ì¼)", min_value=0, max_value=7, value=wd_init, key="wd_input")
        workoutTime = col7.number_input("ì¼ ë‹¹ ìš´ë™í•˜ëŠ” ì‹œê°„ (ì‹œê°„)", min_value=0.0, max_value=5.0, value=wt_init, step=0.1, key="wt_input")
        
        submitted = st.form_submit_button("Streamlitìœ¼ë¡œ ì˜ˆì¸¡ ì‹¤í–‰")

        if submitted:
            # 1. ì…ë ¥ ë°ì´í„° ì¤€ë¹„
            data_input = {
                'weight': weight, 'height': height, 'heartRate': heartRate, 
                'targetWeight': targetWeight, 'targetDuration': targetDuration, 
                'workoutDays': workoutDays, 'workoutTime': workoutTime
            }

            with st.spinner("ëª¨ë¸ ì˜ˆì¸¡ ë° AI ì½”ì¹˜ ë¶„ì„ ì¤‘..."):
                # 2. ì˜ˆì¸¡ ìˆ˜í–‰: ëª¨ë¸ ë¡œë“œ ì„±ê³µ ì—¬ë¶€ì— ë”°ë¼ ì‹¤ì œ ì˜ˆì¸¡ ë˜ëŠ” ì‹œë®¬ë ˆì´ì…˜ ì„ íƒ
                if model_load_success and ORANGE_AVAILABLE:
                    predictions, status_message = predict_with_orange_models(data_input, loaded_models)
                else:
                    predictions, status_message = simulate_orange_prediction(data_input)
                    
                st.caption(f"*(ì˜ˆì¸¡ ìƒíƒœ: {status_message})*")

                # 3. ê²°ê³¼ í‘œì‹œ
                if predictions:
                    col_p1, col_p2, col_p3 = st.columns(3)
                    cols = [col_p1, col_p2, col_p3]
                    
                    for i, (model_name, prediction) in enumerate(predictions.items()):
                        with cols[i]:
                            st.metric(label=f"ëª¨ë¸ {model_name} ì˜ˆì¸¡", value=prediction)
                    
                    # AI ì½”ì¹˜ ì½”ë©˜íŠ¸ ìƒì„±
                    ai_commentary = get_ai_coach_recommendation(data_input, predictions)
                    
                    st.markdown("### ğŸ§‘â€âš•ï¸ AI ì½”ì¹˜ì˜ ì¢…í•© ë¶„ì„")
                    st.write(ai_commentary)
                else:
                    st.error("ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë¸ íŒŒì¼ì´ë‚˜ ì…ë ¥ ë°ì´í„°ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.")

if __name__ == "__main__":
    app()
